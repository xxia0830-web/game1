<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¯€å¥é»æ“Šç‹ (æ¥µé€Ÿç‰ˆ)</title>
    <style>
        :root { --bg-color: #121212; --neon-blue: #00f3ff; --neon-pink: #ff00ff; --text-color: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: radial-gradient(circle, #1a1a2e 0%, #000 100%); color: var(--text-color); display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; touch-action: none; user-select: none; }
        .info-board { display: flex; justify-content: space-between; width: 90%; max-width: 400px; margin-bottom: 10px; font-weight: bold; font-size: 1.2rem; }
        .score-box { text-shadow: 0 0 10px var(--neon-blue); }
        .time-box { text-shadow: 0 0 10px var(--neon-pink); color: var(--neon-pink); }
        #game-area { position: relative; width: 95vw; height: 60vh; max-width: 600px; background: rgba(255,255,255,0.05); border: 2px solid var(--neon-blue); border-radius: 15px; overflow: hidden; }
        .target { position: absolute; width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--neon-pink); animation: popUp 0.1s ease-out; user-select: none; }
        .hit-effect { position: absolute; width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.8); transform: scale(1.2); pointer-events: none; animation: fadeOut 0.2s forwards; }
        @keyframes popUp { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeOut { 100% { opacity: 0; transform: scale(1.5); } }
        #overlay-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px); }
        input { padding: 10px; font-size: 1.2rem; margin: 15px 0; background: rgba(0,0,0,0.5); border: 2px solid var(--neon-blue); color: white; text-align: center; border-radius: 8px; }
        button { padding: 12px 35px; font-size: 1.3rem; background: var(--neon-blue); border: none; border-radius: 50px; font-weight: bold; box-shadow: 0 0 20px var(--neon-blue); cursor: pointer; transition: 0.2s;}
        button:active { transform: scale(0.95); }
        button:disabled { background: #555; box-shadow: none; }
        #leaderboard { margin-top: 20px; width: 80%; max-width: 300px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; border: 1px solid #00ff00; }
        .rank-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #444; }
    </style>
</head>
<body>
    <div class="info-board">
        <div class="score-box">åˆ†æ•¸: <span id="score">0</span></div>
        <div class="time-box">æ™‚é–“: <span id="time">30</span></div>
    </div>
    <div id="game-area"></div>
    <div id="overlay-screen">
        <h1 style="color:white;text-shadow:0 0 10px var(--neon-blue);">NEON STRIKE</h1>
        <div id="input-area">
            <input type="text" id="player-name" placeholder="è¼¸å…¥ä½ çš„åå­—" maxlength="8">
            <br><button id="start-btn">é–‹å§‹æŒ‘æˆ°</button>
            <p id="audio-status" style="color:yellow; font-size:0.8rem; margin-top:10px;">ğŸµ éŸ³æ¨‚æº–å‚™ä¸­...</p>
        </div>
        <h2 id="result-msg" style="display:none; color: var(--neon-pink);">æ™‚é–“åˆ°ï¼</h2>
        <div id="leaderboard">
            <h3 style="margin:0 0 10px 0; text-align:center; color:#00ff00;">ğŸ† å…¨çƒæ’è¡Œæ¦œ</h3>
            <div id="rank-list">è¼‰å…¥ä¸­...</div>
        </div>
        <p style="color:#666; font-size:0.8rem; margin-top:10px;">*è³‡æ–™åŒæ­¥è‡³ Google é›²ç«¯</p>
    </div>

    <audio id="bgm" loop preload="auto">
        <source src="./bgm.m4a" type="audio/mp4">
    </audio>

    <script>
        // ============================================
        // â˜…â˜…â˜… è«‹è¨˜å¾—è²¼ä¸Šä½ çš„ Google Apps Script ç¶²å€ â˜…â˜…â˜…
        const API_URL = "https://script.google.com/macros/s/AKfycbyStLwCxQjgDxCA_fnu9FUtsJZNm7IDpwGeJkc57Xyt0RpV_q51C8ugVRa1EIo8hiek/exec";
        
        // åœ–ç‰‡è¨­å®š: æ”¯æ´ jpg
        const TARGET_IMAGE_URL = "./target.jpg"; 
        const BACKUP_IMAGE_URL = "https://cdn-icons-png.flaticon.com/512/148/148836.png";
        
        // æ™‚é–“è¨­å®š
        const APPEAR_TIME = 450; // â˜… å·²ä¿®æ”¹ç‚º 0.45 ç§’
        // ============================================

        const bgm = document.getElementById('bgm');
        const audioStatus = document.getElementById('audio-status');
        const startBtn = document.getElementById('start-btn');
        const rankList = document.getElementById('rank-list');
        
        let isPlaying = false;
        let score = 0;
        let timeLeft = 30;
        let gameTimer, spawnTimer;

        // --- éŸ³æ•ˆè¨ºæ–· ---
        bgm.addEventListener('canplaythrough', () => {
            audioStatus.innerText = "âœ… éŸ³æ¨‚è®€å–æˆåŠŸ";
            audioStatus.style.color = "#00ff00";
        });
        bgm.addEventListener('error', (e) => {
            audioStatus.innerText = "âŒ æ‰¾ä¸åˆ° bgm.m4a";
            audioStatus.style.color = "red";
        });

        // --- éŠæˆ²é‚è¼¯ ---
        startBtn.addEventListener('click', () => {
            const name = document.getElementById('player-name').value.trim();
            if(!name) return alert("è«‹è¼¸å…¥åå­—");
            
            bgm.currentTime = 0;
            bgm.play().then(() => startGame()).catch(() => {
                alert("è«‹è§£é™¤æ‰‹æ©ŸéœéŸ³æ¨¡å¼");
                startGame();
            });
        });

        function startGame() {
            if(isPlaying) return;
            isPlaying = true;
            score = 0; timeLeft = 30;
            document.getElementById('score').innerText = 0;
            document.getElementById('time').innerText = 30;
            document.getElementById('overlay-screen').style.display = 'none';
            document.getElementById('result-msg').style.display = 'none';
            document.getElementById('input-area').style.display = 'none';

            gameTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('time').innerText = timeLeft;
                if(timeLeft <= 0) endGame();
            }, 1000);

            // ç”Ÿæˆé »ç‡è¨­ç‚º 0.5 ç§’ï¼Œç¨å¾®å¤§æ–¼æ¶ˆå¤±æ™‚é–“ 0.45 ç§’
            spawnTimer = setInterval(spawnTarget, 500);
        }

        function spawnTarget() {
            if(!isPlaying) return;
            const img = document.createElement('img');
            img.src = TARGET_IMAGE_URL;
            img.className = 'target';
            img.onerror = function() { this.src = BACKUP_IMAGE_URL; this.onerror = null; };
            
            const area = document.getElementById('game-area');
            const x = Math.floor(Math.random() * (area.clientWidth - 80));
            const y = Math.floor(Math.random() * (area.clientHeight - 80));
            img.style.left = x + 'px'; img.style.top = y + 'px';

            const hit = (e) => {
                e.preventDefault(); e.stopPropagation();
                score += 15;
                document.getElementById('score').innerText = score;
                createEffect(x, y);
                img.remove();
            };
            img.addEventListener('touchstart', hit, {passive:false});
            img.addEventListener('mousedown', hit);
            area.appendChild(img);

            // â˜… é€™è£¡æ§åˆ¶æ¶ˆå¤±æ™‚é–“ (0.45ç§’)
            setTimeout(() => { if(img.parentNode) img.remove(); }, APPEAR_TIME);
        }

        function createEffect(x, y) {
            const effect = document.createElement('div');
            effect.className = 'hit-effect';
            effect.style.left = x + 'px'; effect.style.top = y + 'px';
            document.getElementById('game-area').appendChild(effect);
            setTimeout(() => effect.remove(), 200);
        }

        function endGame() {
            isPlaying = false;
            clearInterval(gameTimer); clearInterval(spawnTimer);
            bgm.pause();
            document.getElementById('game-area').innerHTML = '';
            document.getElementById('overlay-screen').style.display = 'flex';
            document.getElementById('result-msg').style.display = 'block';
            document.getElementById('result-msg').innerText = `æ™‚é–“åˆ°ï¼å¾—åˆ†: ${score}`;
            document.getElementById('input-area').style.display = 'block';
            startBtn.innerText = "å†ä¾†ä¸€å±€";
            
            const name = document.getElementById('player-name').value;
            uploadScore(name, score);
        }

        // --- æ’è¡Œæ¦œ (POSTç‰ˆ) ---
        fetchLeaderboard();

        function uploadScore(name, score) {
            rankList.innerHTML = '<div class="loading">ä¸Šå‚³ä¸­...</div>';
            startBtn.disabled = true;
            let cleanUrl = API_URL.endsWith('/dev') ? API_URL.replace('/dev', '/exec') : API_URL;
            
            const formData = new FormData();
            formData.append('action', 'add');
            formData.append('name', name);
            formData.append('score', score);

            fetch(cleanUrl, { method: 'POST', body: formData })
            .then(() => fetchLeaderboard())
            .catch(() => { rankList.innerHTML = "ä¸Šå‚³å¤±æ•—"; startBtn.disabled = false; });
        }

        function fetchLeaderboard() {
            rankList.innerHTML = '<div class="loading">è®€å–ä¸­...</div>';
            let cleanUrl = API_URL.endsWith('/dev') ? API_URL.replace('/dev', '/exec') : API_URL;
            
            fetch(cleanUrl + "?action=get")
            .then(r => r.json())
            .then(data => {
                updateLeaderboardUI(data);
                startBtn.disabled = false;
            })
            .catch(() => { 
                rankList.innerHTML = '<div style="color:red;font-size:0.8rem">è®€å–å¤±æ•—<br>è«‹æª¢æŸ¥ç¶²å€æˆ–æ¬Šé™</div>'; 
                startBtn.disabled = false; 
            });
        }

        function updateLeaderboardUI(data) {
            rankList.innerHTML = "";
            if(data.length === 0) { rankList.innerHTML = "å°šç„¡ç´€éŒ„"; return; }
            data.forEach((d, i) => {
                rankList.innerHTML += `<div class="rank-item"><span>${i+1}. ${escapeHtml(d.name)}</span><span style="color:#ff00ff">${d.score}</span></div>`;
            });
        }
        function escapeHtml(t) { return t ? t.replace(/</g,"&lt;") : t; }
    </script>
</body>
</html>
